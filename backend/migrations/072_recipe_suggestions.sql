-- Migration: 072_recipe_suggestions.sql
-- Description: Add body type, cuisine preferences, and recipe suggestion tracking
-- Created: 2024-12-30
-- Feature: "Suggest Recipes based on food, culture, body type and diet"

-- ============================================================================
-- PART 1: ADD BODY TYPE AND CUISINE PREFERENCES TO NUTRITION_PREFERENCES
-- ============================================================================

-- Body type for metabolic-based recommendations
-- Values: 'ectomorph' (fast metabolism), 'mesomorph' (athletic), 'endomorph' (slower metabolism), 'balanced'
ALTER TABLE nutrition_preferences
ADD COLUMN IF NOT EXISTS body_type TEXT DEFAULT 'balanced'
CHECK (body_type IN ('ectomorph', 'mesomorph', 'endomorph', 'balanced'));

COMMENT ON COLUMN nutrition_preferences.body_type IS 'User body type for metabolic recommendations: ectomorph (fast metabolism), mesomorph (athletic), endomorph (slower metabolism), balanced';

-- Favorite cuisines for culturally-appropriate recipe suggestions
-- Array of cuisine types: 'indian', 'italian', 'mexican', 'chinese', 'japanese', 'thai', 'korean', 'mediterranean', 'middle_eastern', 'american', 'french', 'greek', 'spanish', 'vietnamese', 'brazilian', 'african', etc.
ALTER TABLE nutrition_preferences
ADD COLUMN IF NOT EXISTS favorite_cuisines TEXT[] DEFAULT '{}';

COMMENT ON COLUMN nutrition_preferences.favorite_cuisines IS 'Array of preferred cuisines for recipe suggestions (e.g., indian, italian, mexican)';

-- Cultural background (optional, for more personalized suggestions)
ALTER TABLE nutrition_preferences
ADD COLUMN IF NOT EXISTS cultural_background TEXT;

COMMENT ON COLUMN nutrition_preferences.cultural_background IS 'Optional cultural background for deeper recipe personalization';

-- Spice tolerance for recipe adjustments
ALTER TABLE nutrition_preferences
ADD COLUMN IF NOT EXISTS spice_tolerance TEXT DEFAULT 'medium'
CHECK (spice_tolerance IN ('none', 'mild', 'medium', 'hot', 'very_hot'));

COMMENT ON COLUMN nutrition_preferences.spice_tolerance IS 'Spice tolerance level for recipe suggestions';

-- ============================================================================
-- PART 2: RECIPE SUGGESTIONS TABLE (Track AI-generated suggestions)
-- ============================================================================

CREATE TABLE IF NOT EXISTS recipe_suggestions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Recipe data (generated by AI)
    recipe_name VARCHAR(255) NOT NULL,
    recipe_description TEXT,
    cuisine VARCHAR(50),
    category VARCHAR(50),  -- 'breakfast', 'lunch', 'dinner', 'snack'

    -- Ingredients list (JSONB for flexibility)
    ingredients JSONB NOT NULL DEFAULT '[]',
    -- Format: [{"name": "chicken breast", "amount": 200, "unit": "g", "calories": 220, "protein_g": 46}, ...]

    -- Instructions
    instructions TEXT[],  -- Array of step-by-step instructions

    -- Nutrition per serving
    servings INTEGER DEFAULT 1,
    calories_per_serving INTEGER,
    protein_per_serving_g DECIMAL(8,2),
    carbs_per_serving_g DECIMAL(8,2),
    fat_per_serving_g DECIMAL(8,2),
    fiber_per_serving_g DECIMAL(8,2),

    -- Time estimates
    prep_time_minutes INTEGER,
    cook_time_minutes INTEGER,

    -- Why this recipe was suggested
    suggestion_reason TEXT,  -- e.g., "High protein for muscle building, matches your Italian cuisine preference"

    -- Match scores (0-100)
    goal_alignment_score INTEGER,  -- How well it fits user's nutrition goals
    cuisine_match_score INTEGER,   -- How well it matches cuisine preferences
    diet_compliance_score INTEGER, -- How well it fits dietary restrictions
    overall_match_score INTEGER,   -- Combined score

    -- User interaction
    user_rating INTEGER CHECK (user_rating >= 1 AND user_rating <= 5),
    user_saved BOOLEAN DEFAULT FALSE,
    user_cooked BOOLEAN DEFAULT FALSE,
    user_feedback TEXT,

    -- Conversion tracking
    converted_to_recipe_id UUID REFERENCES user_recipes(id),  -- If user saved to their recipes

    -- Generation context
    generation_context JSONB DEFAULT '{}',  -- Store the context used for generation
    -- Format: {"body_type": "mesomorph", "goals": ["build_muscle"], "diet_type": "high_protein", "allergies": [], "cuisines": ["indian"]}

    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    viewed_at TIMESTAMPTZ,
    interacted_at TIMESTAMPTZ
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_recipe_suggestions_user ON recipe_suggestions(user_id);
CREATE INDEX IF NOT EXISTS idx_recipe_suggestions_user_created ON recipe_suggestions(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_recipe_suggestions_saved ON recipe_suggestions(user_id, user_saved) WHERE user_saved = TRUE;
CREATE INDEX IF NOT EXISTS idx_recipe_suggestions_cuisine ON recipe_suggestions(cuisine);
CREATE INDEX IF NOT EXISTS idx_recipe_suggestions_category ON recipe_suggestions(category);
CREATE INDEX IF NOT EXISTS idx_recipe_suggestions_score ON recipe_suggestions(overall_match_score DESC);

COMMENT ON TABLE recipe_suggestions IS 'AI-generated recipe suggestions based on user preferences, goals, body type, and culture';

-- ============================================================================
-- PART 3: RECIPE SUGGESTION SESSIONS (Track suggestion batches)
-- ============================================================================

CREATE TABLE IF NOT EXISTS recipe_suggestion_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- Session context
    meal_type VARCHAR(50),  -- 'breakfast', 'lunch', 'dinner', 'snack', 'any'
    request_type VARCHAR(50) DEFAULT 'general',  -- 'general', 'quick_meal', 'meal_prep', 'special_occasion'

    -- User's state at generation time (snapshot)
    user_context JSONB NOT NULL DEFAULT '{}',
    -- Format: {
    --   "body_type": "mesomorph",
    --   "diet_type": "high_protein",
    --   "nutrition_goals": ["build_muscle", "eat_healthier"],
    --   "allergies": ["peanuts"],
    --   "dietary_restrictions": ["halal"],
    --   "favorite_cuisines": ["indian", "mediterranean"],
    --   "cooking_skill": "intermediate",
    --   "cooking_time_available": 30,
    --   "budget_level": "moderate",
    --   "spice_tolerance": "medium",
    --   "target_calories": 2500,
    --   "target_protein_g": 180
    -- }

    -- Results
    suggestions_count INTEGER DEFAULT 0,
    suggestions_generated JSONB DEFAULT '[]',  -- Array of suggestion IDs

    -- Generation metadata
    ai_model_used VARCHAR(50) DEFAULT 'gemini-2.0-flash',
    generation_time_ms INTEGER,

    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_recipe_suggestion_sessions_user ON recipe_suggestion_sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_recipe_suggestion_sessions_user_date ON recipe_suggestion_sessions(user_id, created_at DESC);

COMMENT ON TABLE recipe_suggestion_sessions IS 'Tracks recipe suggestion generation sessions for analytics';

-- ============================================================================
-- PART 4: CUISINE REFERENCE TABLE (For UI dropdowns)
-- ============================================================================

CREATE TABLE IF NOT EXISTS cuisine_types (
    code VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    region VARCHAR(100),
    typical_ingredients TEXT[],
    typical_spice_level TEXT DEFAULT 'medium',
    display_order INTEGER DEFAULT 100
);

-- Populate with common cuisines
INSERT INTO cuisine_types (code, name, region, typical_ingredients, typical_spice_level, display_order)
VALUES
    ('indian', 'Indian', 'South Asia', ARRAY['rice', 'lentils', 'ghee', 'turmeric', 'cumin', 'garam masala'], 'hot', 1),
    ('italian', 'Italian', 'Europe', ARRAY['pasta', 'olive oil', 'tomatoes', 'basil', 'parmesan'], 'mild', 2),
    ('mexican', 'Mexican', 'Americas', ARRAY['tortillas', 'beans', 'rice', 'cilantro', 'lime', 'chili'], 'hot', 3),
    ('chinese', 'Chinese', 'East Asia', ARRAY['rice', 'soy sauce', 'ginger', 'garlic', 'sesame oil'], 'medium', 4),
    ('japanese', 'Japanese', 'East Asia', ARRAY['rice', 'soy sauce', 'miso', 'seaweed', 'fish'], 'mild', 5),
    ('thai', 'Thai', 'Southeast Asia', ARRAY['rice', 'coconut milk', 'fish sauce', 'lemongrass', 'basil'], 'hot', 6),
    ('korean', 'Korean', 'East Asia', ARRAY['rice', 'kimchi', 'gochujang', 'sesame', 'garlic'], 'hot', 7),
    ('mediterranean', 'Mediterranean', 'Europe/Middle East', ARRAY['olive oil', 'legumes', 'vegetables', 'fish', 'herbs'], 'mild', 8),
    ('middle_eastern', 'Middle Eastern', 'Middle East', ARRAY['hummus', 'pita', 'lamb', 'tahini', 'za''atar'], 'medium', 9),
    ('american', 'American', 'Americas', ARRAY['beef', 'potatoes', 'corn', 'cheese', 'bread'], 'mild', 10),
    ('french', 'French', 'Europe', ARRAY['butter', 'wine', 'herbs', 'cheese', 'cream'], 'mild', 11),
    ('greek', 'Greek', 'Europe', ARRAY['olive oil', 'feta', 'olives', 'yogurt', 'lamb'], 'mild', 12),
    ('spanish', 'Spanish', 'Europe', ARRAY['olive oil', 'saffron', 'paprika', 'seafood', 'chorizo'], 'mild', 13),
    ('vietnamese', 'Vietnamese', 'Southeast Asia', ARRAY['rice noodles', 'fish sauce', 'herbs', 'lime', 'pho'], 'medium', 14),
    ('brazilian', 'Brazilian', 'Americas', ARRAY['beans', 'rice', 'beef', 'farofa', 'lime'], 'medium', 15),
    ('african', 'African', 'Africa', ARRAY['plantains', 'yams', 'peanuts', 'okra', 'berbere'], 'hot', 16),
    ('caribbean', 'Caribbean', 'Americas', ARRAY['rice', 'beans', 'plantains', 'jerk seasoning', 'coconut'], 'hot', 17),
    ('german', 'German', 'Europe', ARRAY['potatoes', 'sausage', 'cabbage', 'beer', 'bread'], 'mild', 18),
    ('turkish', 'Turkish', 'Middle East/Europe', ARRAY['lamb', 'yogurt', 'eggplant', 'herbs', 'pomegranate'], 'medium', 19),
    ('persian', 'Persian/Iranian', 'Middle East', ARRAY['rice', 'saffron', 'dried fruits', 'herbs', 'lamb'], 'mild', 20)
ON CONFLICT (code) DO UPDATE SET
    name = EXCLUDED.name,
    region = EXCLUDED.region,
    typical_ingredients = EXCLUDED.typical_ingredients,
    typical_spice_level = EXCLUDED.typical_spice_level,
    display_order = EXCLUDED.display_order;

-- ============================================================================
-- PART 5: BODY TYPE REFERENCE TABLE (For UI and recommendations)
-- ============================================================================

CREATE TABLE IF NOT EXISTS body_types (
    code VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    metabolism_type TEXT,
    recommended_macro_ratios JSONB,  -- {"protein": 30, "carbs": 40, "fat": 30}
    dietary_tips TEXT[],
    display_order INTEGER DEFAULT 100
);

-- Populate body types
INSERT INTO body_types (code, name, description, metabolism_type, recommended_macro_ratios, dietary_tips, display_order)
VALUES
    ('ectomorph', 'Ectomorph', 'Lean build, fast metabolism, difficulty gaining weight', 'fast',
     '{"protein": 25, "carbs": 50, "fat": 25}',
     ARRAY['Focus on calorie-dense foods', 'Eat more frequently', 'Include complex carbs', 'Don''t skip meals'], 1),

    ('mesomorph', 'Mesomorph', 'Athletic build, moderate metabolism, gains muscle easily', 'moderate',
     '{"protein": 30, "carbs": 40, "fat": 30}',
     ARRAY['Balance protein and carbs', 'Vary calorie intake based on goals', 'Focus on whole foods', 'Time carbs around workouts'], 2),

    ('endomorph', 'Endomorph', 'Rounder build, slower metabolism, stores fat easily', 'slow',
     '{"protein": 35, "carbs": 25, "fat": 40}',
     ARRAY['Focus on protein and healthy fats', 'Limit refined carbs', 'Eat fiber-rich foods', 'Watch portion sizes'], 3),

    ('balanced', 'Balanced/Mixed', 'Combination of body types', 'moderate',
     '{"protein": 30, "carbs": 40, "fat": 30}',
     ARRAY['Follow standard macro guidelines', 'Adjust based on activity level', 'Listen to your body', 'Focus on nutrient density'], 4)
ON CONFLICT (code) DO UPDATE SET
    name = EXCLUDED.name,
    description = EXCLUDED.description,
    metabolism_type = EXCLUDED.metabolism_type,
    recommended_macro_ratios = EXCLUDED.recommended_macro_ratios,
    dietary_tips = EXCLUDED.dietary_tips,
    display_order = EXCLUDED.display_order;

-- ============================================================================
-- PART 6: ROW LEVEL SECURITY
-- ============================================================================

-- RLS for recipe_suggestions
ALTER TABLE recipe_suggestions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS recipe_suggestions_select_policy ON recipe_suggestions;
CREATE POLICY recipe_suggestions_select_policy ON recipe_suggestions
    FOR SELECT USING (auth.uid() = user_id);

DROP POLICY IF EXISTS recipe_suggestions_insert_policy ON recipe_suggestions;
CREATE POLICY recipe_suggestions_insert_policy ON recipe_suggestions
    FOR INSERT WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS recipe_suggestions_update_policy ON recipe_suggestions;
CREATE POLICY recipe_suggestions_update_policy ON recipe_suggestions
    FOR UPDATE USING (auth.uid() = user_id);

DROP POLICY IF EXISTS recipe_suggestions_delete_policy ON recipe_suggestions;
CREATE POLICY recipe_suggestions_delete_policy ON recipe_suggestions
    FOR DELETE USING (auth.uid() = user_id);

-- Service role policy
DROP POLICY IF EXISTS recipe_suggestions_service_all ON recipe_suggestions;
CREATE POLICY recipe_suggestions_service_all ON recipe_suggestions
    FOR ALL TO service_role USING (true) WITH CHECK (true);

-- RLS for recipe_suggestion_sessions
ALTER TABLE recipe_suggestion_sessions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS recipe_suggestion_sessions_select_policy ON recipe_suggestion_sessions;
CREATE POLICY recipe_suggestion_sessions_select_policy ON recipe_suggestion_sessions
    FOR SELECT USING (auth.uid() = user_id);

DROP POLICY IF EXISTS recipe_suggestion_sessions_insert_policy ON recipe_suggestion_sessions;
CREATE POLICY recipe_suggestion_sessions_insert_policy ON recipe_suggestion_sessions
    FOR INSERT WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS recipe_suggestion_sessions_service_all ON recipe_suggestion_sessions;
CREATE POLICY recipe_suggestion_sessions_service_all ON recipe_suggestion_sessions
    FOR ALL TO service_role USING (true) WITH CHECK (true);

-- ============================================================================
-- PART 7: USER CONTEXT LOG EVENT TYPES (Add new event types)
-- ============================================================================

-- Note: Event types are defined in code (user_context_service.py)
-- New events to add:
-- - recipe_suggestion_requested
-- - recipe_suggestion_viewed
-- - recipe_suggestion_saved
-- - recipe_suggestion_cooked
-- - recipe_suggestion_rated

-- ============================================================================
-- MIGRATION COMPLETE
-- ============================================================================
