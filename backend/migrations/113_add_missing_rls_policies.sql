-- Migration: 113_add_missing_rls_policies.sql
-- Description: Add RLS policies to tables that have RLS enabled but no policies defined
-- Created: 2026-01-01
-- Tables affected: generated_workouts, user_progression_preferences

-- ============================================
-- GENERATED_WORKOUTS TABLE POLICIES
-- ============================================
-- This table stores user-specific workout data generated by the AI

-- Users can view their own generated workouts
CREATE POLICY "Users can view their own generated workouts"
ON public.generated_workouts FOR SELECT
USING (auth.uid() = user_id);

-- Users can insert their own generated workouts
CREATE POLICY "Users can insert their own generated workouts"
ON public.generated_workouts FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- Users can update their own generated workouts
CREATE POLICY "Users can update their own generated workouts"
ON public.generated_workouts FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- Users can delete their own generated workouts
CREATE POLICY "Users can delete their own generated workouts"
ON public.generated_workouts FOR DELETE
USING (auth.uid() = user_id);

-- Service role can manage all generated workouts (for backend operations)
CREATE POLICY "Service role can manage generated workouts"
ON public.generated_workouts FOR ALL
USING (auth.jwt() ->> 'role' = 'service_role');

-- ============================================
-- USER_PROGRESSION_PREFERENCES TABLE POLICIES
-- ============================================
-- This table stores user-specific progression pace preferences

-- Users can view their own progression preferences
CREATE POLICY "Users can view their own progression preferences"
ON public.user_progression_preferences FOR SELECT
USING (auth.uid() = user_id);

-- Users can insert their own progression preferences
CREATE POLICY "Users can insert their own progression preferences"
ON public.user_progression_preferences FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- Users can update their own progression preferences
CREATE POLICY "Users can update their own progression preferences"
ON public.user_progression_preferences FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- Users can delete their own progression preferences
CREATE POLICY "Users can delete their own progression preferences"
ON public.user_progression_preferences FOR DELETE
USING (auth.uid() = user_id);

-- Service role can manage all progression preferences (for backend operations)
CREATE POLICY "Service role can manage progression preferences"
ON public.user_progression_preferences FOR ALL
USING (auth.jwt() ->> 'role' = 'service_role');

-- ============================================
-- COMMENTS
-- ============================================

COMMENT ON POLICY "Users can view their own generated workouts" ON public.generated_workouts IS
  'RLS: Users can only SELECT their own workout data based on user_id = auth.uid()';

COMMENT ON POLICY "Users can insert their own generated workouts" ON public.generated_workouts IS
  'RLS: Users can only INSERT workouts where user_id matches their auth.uid()';

COMMENT ON POLICY "Users can update their own generated workouts" ON public.generated_workouts IS
  'RLS: Users can only UPDATE their own workouts, verified on both read and write';

COMMENT ON POLICY "Users can delete their own generated workouts" ON public.generated_workouts IS
  'RLS: Users can only DELETE their own workout data';

COMMENT ON POLICY "Users can view their own progression preferences" ON public.user_progression_preferences IS
  'RLS: Users can only SELECT their own progression preferences';

COMMENT ON POLICY "Users can insert their own progression preferences" ON public.user_progression_preferences IS
  'RLS: Users can only INSERT preferences where user_id matches their auth.uid()';

COMMENT ON POLICY "Users can update their own progression preferences" ON public.user_progression_preferences IS
  'RLS: Users can only UPDATE their own preferences, verified on both read and write';

COMMENT ON POLICY "Users can delete their own progression preferences" ON public.user_progression_preferences IS
  'RLS: Users can only DELETE their own preference data';
