"""
Test script for onboarding service.
Tests data extraction with 10+ sample user messages.

Following CLAUDE.md: TEST BEFORE DEPLOY
Run this script before building frontend to ensure extraction works correctly.

Usage:
    python test_onboarding.py
"""
import asyncio
import json
from services.openai_service import OpenAIService
from services.onboarding_service import OnboardingService


# Test cases with expected extractions
TEST_CASES = [
    {
        "name": "Name introduction",
        "message": "Sarah",
        "current_data": {},
        "expected_fields": ["name"],
    },
    {
        "name": "Kettlebell home workouts",
        "message": "I want to do kettlebell workouts at home to build muscle",
        "current_data": {"name": "Sarah"},
        "expected_fields": ["goals", "equipment"],
    },
    {
        "name": "Days per week - natural language",
        "message": "3 times a week",
        "current_data": {"name": "Sarah", "goals": ["Build Muscle"], "equipment": ["Kettlebell"]},
        "expected_fields": ["days_per_week"],
    },
    {
        "name": "Age and gender",
        "message": "I'm 28 and female",
        "current_data": {"name": "Sarah"},
        "expected_fields": ["age", "gender"],
    },
    {
        "name": "Height in imperial",
        "message": "I'm 5'7\"",
        "current_data": {},
        "expected_fields": ["heightCm"],
    },
    {
        "name": "Weight in lbs",
        "message": "I weigh 150 pounds",
        "current_data": {},
        "expected_fields": ["weightKg"],
    },
    {
        "name": "Bodyweight home workouts",
        "message": "I just want bodyweight exercises at home",
        "current_data": {},
        "expected_fields": ["equipment"],
    },
    {
        "name": "Lose weight goal",
        "message": "I want to lose some fat and get toned",
        "current_data": {},
        "expected_fields": ["goals"],
    },
    {
        "name": "Fitness level - beginner",
        "message": "I'm pretty new to working out, maybe beginner level",
        "current_data": {},
        "expected_fields": ["fitness_level"],
    },
    {
        "name": "Fitness level - advanced",
        "message": "I've been training for 5 years, I'd say I'm advanced",
        "current_data": {},
        "expected_fields": ["fitness_level"],
    },
    {
        "name": "Schedule - informal",
        "message": "I can do Monday, Wednesday, and Friday mornings",
        "current_data": {},
        "expected_fields": ["days_per_week", "selected_days"],
    },
    {
        "name": "Full gym access",
        "message": "I have a full gym membership with all equipment",
        "current_data": {},
        "expected_fields": ["equipment"],
    },
]


async def test_extraction():
    """Test OpenAI extraction with sample messages."""
    print("üß™ Testing Onboarding Extraction")
    print("=" * 60)

    openai_service = OpenAIService()
    onboarding_service = OnboardingService(openai_service)

    passed = 0
    failed = 0

    for i, test_case in enumerate(TEST_CASES, 1):
        print(f"\nüìù Test {i}: {test_case['name']}")
        print(f"   Message: \"{test_case['message']}\"")

        try:
            # Extract data
            extracted = await onboarding_service._extract_data_from_message(
                test_case["message"],
                test_case["current_data"]
            )

            print(f"   ‚úÖ Extracted: {json.dumps(extracted, indent=6)}")

            # Check if expected fields were extracted
            missing_fields = []
            for field in test_case["expected_fields"]:
                if field not in extracted or not extracted[field]:
                    missing_fields.append(field)

            if missing_fields:
                print(f"   ‚ö†Ô∏è  Missing expected fields: {missing_fields}")
                failed += 1
            else:
                print(f"   ‚úÖ All expected fields extracted!")
                passed += 1

        except Exception as e:
            print(f"   ‚ùå ERROR: {e}")
            failed += 1

    # Summary
    print("\n" + "=" * 60)
    print(f"üìä Test Summary:")
    print(f"   ‚úÖ Passed: {passed}/{len(TEST_CASES)}")
    print(f"   ‚ùå Failed: {failed}/{len(TEST_CASES)}")

    if failed == 0:
        print("\nüéâ All tests passed! Backend is ready for frontend integration.")
        return True
    else:
        print(f"\n‚ö†Ô∏è  {failed} tests failed. Review extraction logic before proceeding.")
        return False


async def test_full_conversation_flow():
    """Test a complete onboarding conversation flow."""
    print("\n\nüîÑ Testing Full Conversation Flow")
    print("=" * 60)

    openai_service = OpenAIService()
    onboarding_service = OnboardingService(openai_service)

    conversation = [
        "Sarah",
        "I want to build muscle with kettlebells at home",
        "3 days a week",
        "Monday, Wednesday, Friday",
        "45 minutes",
        "I'm intermediate level",
        "28 years old and female",
        "5'6\" and 140 lbs",
    ]

    current_data = {}

    for i, message in enumerate(conversation, 1):
        print(f"\nüó£Ô∏è  User ({i}): {message}")

        result = await onboarding_service.process_user_message(message, current_data)

        print(f"   üìä Extracted: {result['extracted_data']}")
        print(f"   ‚ùì Next: {result['next_question'].get('question', 'COMPLETE')[:80]}...")
        print(f"   ‚úÖ Complete: {result['is_complete']}")

        # Merge extracted data
        current_data = {**current_data, **result['extracted_data']}

        if result['is_complete']:
            print(f"\nüéØ Onboarding Complete!")
            break

    print(f"\nüìã Final Collected Data:")
    print(json.dumps(current_data, indent=2))

    # Validate completeness
    validator = onboarding_service.validator
    is_complete, missing = validator.is_complete(current_data)

    if is_complete:
        print(f"\n‚úÖ All required fields collected!")
        return True
    else:
        print(f"\n‚ö†Ô∏è  Missing required fields: {missing}")
        return False


async def main():
    """Run all tests."""
    print("\nüöÄ Onboarding Backend Test Suite")
    print("Following CLAUDE.md: NO MOCK DATA, TEST BEFORE DEPLOY\n")

    # Test 1: Individual extractions
    extraction_passed = await test_extraction()

    # Test 2: Full conversation flow
    flow_passed = await test_full_conversation_flow()

    # Final verdict
    print("\n" + "=" * 60)
    if extraction_passed and flow_passed:
        print("üéâ ALL TESTS PASSED!")
        print("‚úÖ Backend is ready for frontend development")
        print("‚úÖ Proceed with building ConversationalOnboarding.tsx")
    else:
        print("‚ùå TESTS FAILED!")
        print("‚ö†Ô∏è  Fix backend issues before proceeding to frontend")
        print("‚ö†Ô∏è  Review extraction prompts and validation logic")

    print("=" * 60)


if __name__ == "__main__":
    asyncio.run(main())
